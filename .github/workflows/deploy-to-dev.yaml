name: Promote to Dev
description: "This action does not depend on the branch."

env:
  # ðŸ–Šï¸ EDIT your repository secrets to log into your OpenShift cluster and set up the context.
  # See https://github.com/redhat-actions/oc-login#readme for how to retrieve these values.
  # To get a permanent token, refer to https://github.com/redhat-actions/oc-login/wiki/Using-a-Service-Account-for-GitHub-Actions
  OPENSHIFT_SERVER: ${{ vars.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
  OPENSHIFT_NAMESPACE: ${{ secrets.ECER_NAMESPACE_NO_ENV }}-tools
  APP_ENVIRONMENT_DESTINATION: "dev"

on:
  workflow_dispatch:
    inputs:
      registry_portal_version:
        description: "Registry portal Version (ex. master, release-1.0.0 or release-1.0.1 .etc). Leave empty to skip."
        default: ""
        required: false
      api_version:
        description: "Api version (ex. master, release-1.0.0 or release-1.0.1 .etc). Leave empty to skip."
        default: ""
        required: false
      e2e_test_version:
        description: "E2ETest version (ex. master, release-1.0.0 or release-1.0.1 .etc). Leave empty to skip."
        default: ""
        required: false

jobs:
  openshift-cd:
    name: Promote Image
    runs-on: ubuntu-22.04
    environment: dev

    steps:
      - name: Check All Inputs
        run: |
          isValid="true"

          validate_version_input() {
            local app_name=$1
            local version=$2
            
            if [[ "$version" == "master" ]] || [[ "$version" == "release-"* ]] || [[ "$version" == '' ]]; then
              echo "$app_name input validated: $version"
            else
              echo "::error::$app_name input must be 'master' or 'release-*' or empty. Your input was $version"
              isValid="false"
            fi
          }

          validate_version_input "E2ETest" "${{github.event.inputs.e2e_test_version}}"
          validate_version_input "RegistryPortal" "${{github.event.inputs.registry_portal_version}}"
          validate_version_input "Api" "${{github.event.inputs.api_version}}"

          if [[ "$isValid" == "false" ]]; then
            exit 1
          fi

      - name: Check out repository
        uses: actions/checkout@v5
      - name: Install oc
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: 4

      - name: Tag in OpenShift and Generate Summary
        run: |
          set -eux
          oc login --token=${{ env.OPENSHIFT_TOKEN }} --server=${{ env.OPENSHIFT_SERVER }}
          oc project ${{ env.OPENSHIFT_NAMESPACE }}

          echo "Promoting imagestreams to ${{env.APP_ENVIRONMENT_DESTINATION}}"

          # Initialize the summary content
          echo "## API Deployment Summary to ${{env.APP_ENVIRONMENT_DESTINATION}}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY # Add an empty line for spacing

          # Function to perform oc tagging and append to summary
          tag_image() {
            local image_stream_name=$1
            local version_input=$2
            local destination_env=$3

            if [[ -n "$version_input" ]]; then
              echo "Promoting $image_stream_name:$version_input"
              oc tag -n ${{env.OPENSHIFT_NAMESPACE}} --alias=true "$image_stream_name":"$version_input" "$image_stream_name":"$destination_env"
              echo "- âœ… **$image_stream_name**: Deployed version \`$version_input\`" >> $GITHUB_STEP_SUMMARY
            else
              # This line will now always be added if input is empty, ensuring all inputs are listed
              echo "Skipping $image_stream_name as no version was provided"
              echo "- âŒ **$image_stream_name**: Skipped (no version provided)" >> $GITHUB_STEP_SUMMARY
            fi
          }

          # --- Process each API and add to summary ---
          tag_image "registry-portal" "${{github.event.inputs.registry_portal_version}}" "${{env.APP_ENVIRONMENT_DESTINATION}}"
          tag_image "api" "${{github.event.inputs.api_version}}" "${{env.APP_ENVIRONMENT_DESTINATION}}"

          # E2ETestData only exists in Dev and is used for automation testing, this will not exist in higher environments.
          tag_image "e2e-test-data" "${{github.event.inputs.e2e_test_version}}" "${{env.APP_ENVIRONMENT_DESTINATION}}"
